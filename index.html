<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apostilas Premium - Impressão e Encadernação Profissional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- ViaCEP API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        /* Mantenha todos os estilos CSS anteriores */
        /* ... */
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --pix-color: #32BCAD;
        }
        
        /* ... (mantenha todos os estilos existentes) ... */
        
    </style>
</head>
<body>
    <!-- Mantenha todo o HTML anterior -->
    <!-- ... -->

    <script>
        // ================= CONFIGURAÇÃO INICIAL =================
        // Dados do sistema
        let cart = [];
        let currentOrderNumber = '';
        
        // SUAS INFORMAÇÕES PIX REAIS - CONFIGURE AQUI
        let pixConfig = {
            key: "13991848707", // SEU PIX CPF AQUI - ATUALIZADO
            name: "Apostilas Premium", // SEU NOME OU NOME DA EMPRESA
            city: "São Paulo", // SUA CIDADE
            type: "CPF" // Tipo da chave PIX
        };
        
        let orders = [];

        // Elementos do DOM
        const cartIcon = document.getElementById('cartIcon');
        const cartModal = document.getElementById('cartModal');
        const checkoutModal = document.getElementById('checkoutModal');
        const pixModal = document.getElementById('pixModal');
        const closeModal = document.querySelectorAll('.close-modal');
        const cartItems = document.getElementById('cartItems');
        const cartSubtotal = document.getElementById('cartSubtotal');
        const cartShipping = document.getElementById('cartShipping');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutButton = document.getElementById('checkout-button');
        const confirmPurchaseButton = document.getElementById('confirm-purchase');
        const cartCount = document.querySelector('.cart-count');
        
        // Elementos PIX
        const pixAmount = document.getElementById('pixAmount');
        const pixCode = document.getElementById('pixCode');
        const pixPaidBtn = document.getElementById('pixPaidBtn');
        const qrCodeCanvas = document.getElementById('qrCodeCanvas');
        
        // Modais
        const loadingModal = document.getElementById('loadingModal');
        const loadingText = document.getElementById('loadingText');
        const successModal = document.getElementById('successModal');
        const successButton = document.getElementById('successButton');
        const orderNumber = document.getElementById('orderNumber');
        
        // Admin
        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const adminTabs = document.querySelectorAll('.admin-tab');
        const savePixConfigBtn = document.getElementById('savePixConfig');
        const clearOrdersBtn = document.getElementById('clearOrders');
        const ordersList = document.getElementById('ordersList');
        
        // Botões "Adicionar ao Carrinho"
        const addToCartButtons = document.querySelectorAll('.add-to-cart');
        
        // Botão para adicionar apostila personalizada
        const addCustomToCartButton = document.getElementById('addCustomToCart');
        
        // Notificação
        const copiedNotification = document.getElementById('copiedNotification');
        
        // Elementos do formulário
        const customerCEP = document.getElementById('customerCEP');
        const customerAddress = document.getElementById('customerAddress');
        const customerNumber = document.getElementById('customerNumber');
        const customerComplement = document.getElementById('customerComplement');
        const customerCity = document.getElementById('customerCity');
        const customerState = document.getElementById('customerState');
        const cepLoading = document.getElementById('cepLoading');

        // ================= FUNÇÕES DO CARRINHO =================
        function updateCart() {
            cartCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; padding: 20px;">Seu carrinho está vazio</p>';
                cartSubtotal.textContent = 'R$ 0,00';
                cartShipping.textContent = 'R$ 0,00';
                cartTotal.textContent = 'R$ 0,00';
                return;
            }
            
            let subtotal = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.description || 'Apostila encadernada com espiral'}</p>
                    </div>
                    <div class="cart-item-price">R$ ${item.price.toFixed(2)}</div>
                    <div class="cart-item-actions">
                        <button class="quantity-btn decrease-quantity" data-id="${item.id}">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn increase-quantity" data-id="${item.id}">+</button>
                        <button class="quantity-btn remove-item" data-id="${item.id}" style="margin-left: 10px; color: #e74c3c;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            const shipping = subtotal > 50 ? 0 : 10;
            const total = subtotal + shipping;
            
            cartSubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
            cartShipping.textContent = shipping === 0 ? 'Grátis' : `R$ ${shipping.toFixed(2)}`;
            cartTotal.textContent = `R$ ${total.toFixed(2)}`;
            
            document.querySelectorAll('.decrease-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    decreaseQuantity(id);
                });
            });
            
            document.querySelectorAll('.increase-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    increaseQuantity(id);
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('button').getAttribute('data-id');
                    removeFromCart(id);
                });
            });
        }
        
        function addToCart(id, name, price, description = '') {
            const existingItem = cart.find(item => item.id === id);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id,
                    name,
                    price: parseFloat(price),
                    quantity: 1,
                    description
                });
            }
            
            updateCart();
        }
        
        function increaseQuantity(id) {
            const item = cart.find(item => item.id === id);
            if (item) {
                item.quantity += 1;
                updateCart();
            }
        }
        
        function decreaseQuantity(id) {
            const item = cart.find(item => item.id === id);
            if (item && item.quantity > 1) {
                item.quantity -= 1;
                updateCart();
            }
        }
        
        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCart();
        }

        // ================= FUNÇÕES DE FORMULÁRIO =================
        // Formatação do CEP
        function formatCEP(cep) {
            cep = cep.replace(/\D/g, '');
            if (cep.length > 5) {
                cep = cep.substring(0, 5) + '-' + cep.substring(5, 8);
            }
            return cep;
        }
        
        // Formatação do telefone
        function formatPhone(phone) {
            phone = phone.replace(/\D/g, '');
            if (phone.length > 10) {
                return phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (phone.length > 6) {
                return phone.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (phone.length > 2) {
                return phone.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            } else {
                return phone;
            }
        }
        
        // Buscar endereço pelo CEP usando ViaCEP
        function buscarCEP(cep) {
            cep = cep.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                return;
            }
            
            cepLoading.style.display = 'block';
            
            // Usando ViaCEP
            const url = `https://viacep.com.br/ws/${cep}/json/`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        customerAddress.value = data.logradouro || '';
                        customerCity.value = data.localidade || '';
                        customerState.value = data.uf || '';
                        
                        // Foca no campo de número após preencher o endereço
                        customerNumber.focus();
                        
                        showNotification('Endereço preenchido automaticamente!');
                    } else {
                        showNotification('CEP não encontrado. Por favor, preencha manualmente.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    showNotification('Erro ao buscar CEP. Preencha manualmente.', 'error');
                })
                .finally(() => {
                    cepLoading.style.display = 'none';
                });
        }

        // ================= FUNÇÕES PIX CORRIGIDAS =================
        function generateOrderNumber() {
            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 1000);
            return `AP${timestamp.toString().slice(-6)}${randomNum.toString().padStart(3, '0')}`;
        }
        
        function generatePixCode(amount, orderId) {
            // Verificar se o PIX está configurado
            if (!pixConfig.key || !pixConfig.name || !pixConfig.city) {
                throw new Error('PIX não configurado. Configure suas informações PIX primeiro.');
            }
            
            // Limpar a chave PIX (remover caracteres não numéricos)
            const pixKey = pixConfig.key.replace(/\D/g, '');
            
            // Determinar tipo da chave PIX
            let keyType = "02"; // CPF (11 dígitos)
            
            // Formatar valor (em centavos, sem separador)
            const valor = (amount * 100).toFixed(0).padStart(10, '0');
            
            // Nome e cidade limitados
            const merchantName = pixConfig.name.substring(0, 25);
            const merchantCity = pixConfig.city.substring(0, 15);
            
            // Construir payload PIX
            const payload = [
                // Payload Format Indicator (obrigatório)
                { id: "00", value: "01" },
                
                // Point of Initiation Method (12 = pagamento dinâmico)
                { id: "01", value: "12" },
                
                // Merchant Account Information
                { 
                    id: "26", 
                    children: [
                        { id: "00", value: "BR.GOV.BCB.PIX" },
                        { id: "01", value: pixKey },
                        { id: "02", value: keyType }
                    ] 
                },
                
                // Merchant Category Code
                { id: "52", value: "0000" },
                
                // Transaction Currency (BRL = 986)
                { id: "53", value: "986" },
                
                // Transaction Amount
                { id: "54", value: valor },
                
                // Country Code (BR = Brasil)
                { id: "58", value: "BR" },
                
                // Merchant Name
                { id: "59", value: merchantName },
                
                // Merchant City
                { id: "60", value: merchantCity },
                
                // Additional Data Field Template (ID do pedido)
                { 
                    id: "62", 
                    children: [
                        { id: "05", value: orderId }
                    ] 
                }
            ];
            
            // Construir string do payload
            let payloadString = "";
            
            payload.forEach(field => {
                if (field.children) {
                    // Campo com subcampos
                    let childrenString = "";
                    field.children.forEach(child => {
                        const childLength = child.value.length.toString().padStart(2, '0');
                        childrenString += child.id + childLength + child.value;
                    });
                    
                    const fieldLength = childrenString.length.toString().padStart(2, '0');
                    payloadString += field.id + fieldLength + childrenString;
                } else {
                    // Campo simples
                    const fieldLength = field.value.length.toString().padStart(2, '0');
                    payloadString += field.id + fieldLength + field.value;
                }
            });
            
            // Adicionar CRC16 ao final
            payloadString += "6304";
            const crc = calculateCRC16(payloadString);
            
            return payloadString + crc;
        }
        
        function calculateCRC16(str) {
            let crc = 0xFFFF;
            
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                crc ^= charCode << 8;
                
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ 0x1021;
                    } else {
                        crc = crc << 1;
                    }
                    crc &= 0xFFFF;
                }
            }
            
            return crc.toString(16).toUpperCase().padStart(4, '0');
        }
        
        function generateQRCode(pixCode) {
            // Limpar canvas antes de gerar novo QR Code
            const ctx = qrCodeCanvas.getContext('2d');
            ctx.clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
            
            // Gerar QR Code
            QRCode.toCanvas(qrCodeCanvas, pixCode, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function(error) {
                if (error) {
                    console.error('Erro ao gerar QR Code:', error);
                    // Tentar método alternativo
                    try {
                        // Gerar QR Code usando método simples
                        const qr = qrcode(0, 'M');
                        qr.addData(pixCode);
                        qr.make();
                        
                        const qrSize = 200;
                        const cellSize = qrSize / qr.getModuleCount();
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, qrSize, qrSize);
                        
                        ctx.fillStyle = '#000000';
                        for (let row = 0; row < qr.getModuleCount(); row++) {
                            for (let col = 0; col < qr.getModuleCount(); col++) {
                                if (qr.isDark(row, col)) {
                                    ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao gerar QR Code alternativo:', e);
                        ctx.font = '16px Arial';
                        ctx.fillText('QR Code não disponível', 10, 100);
                        ctx.fillText('Use o código PIX abaixo', 10, 120);
                    }
                }
            });
        }
        
        // Função auxiliar para QR Code (se necessário)
        function qrcode(typeNumber, errorCorrectionLevel) {
            return {
                addData: function(data) {
                    this.data = data;
                },
                make: function() {
                    this.modules = [];
                    // Implementação simplificada
                },
                getModuleCount: function() {
                    return 21; // Tamanho padrão
                },
                isDark: function(row, col) {
                    // Padrão simples para demonstração
                    return (row + col) % 3 === 0;
                }
            };
        }
        
        function showNotification(message, type = 'success') {
            copiedNotification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            copiedNotification.style.display = 'block';
            copiedNotification.style.backgroundColor = type === 'success' ? '#2ecc71' : '#e74c3c';
            
            setTimeout(() => {
                copiedNotification.style.display = 'none';
            }, 3000);
        }

        // ================= PROCESSAMENTO DE PEDIDOS =================
        function validateOrderForm() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerCEP = document.getElementById('customerCEP').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const customerNumber = document.getElementById('customerNumber').value.trim();
            const customerCity = document.getElementById('customerCity').value.trim();
            const customerState = document.getElementById('customerState').value;
            
            // Validar campos obrigatórios
            if (!customerName) {
                showNotification('Preencha o nome completo!', 'error');
                document.getElementById('customerName').focus();
                return false;
            }
            
            if (!customerPhone) {
                showNotification('Preencha o telefone/WhatsApp!', 'error');
                document.getElementById('customerPhone').focus();
                return false;
            }
            
            if (!customerEmail) {
                showNotification('Preencha o e-mail!', 'error');
                document.getElementById('customerEmail').focus();
                return false;
            }
            
            // Validar e-mail
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(customerEmail)) {
                showNotification('E-mail inválido!', 'error');
                document.getElementById('customerEmail').focus();
                return false;
            }
            
            if (!customerCEP || customerCEP.replace(/\D/g, '').length !== 8) {
                showNotification('CEP inválido!', 'error');
                document.getElementById('customerCEP').focus();
                return false;
            }
            
            if (!customerAddress) {
                showNotification('Preencha o endereço!', 'error');
                document.getElementById('customerAddress').focus();
                return false;
            }
            
            if (!customerNumber) {
                showNotification('Preencha o número!', 'error');
                document.getElementById('customerNumber').focus();
                return false;
            }
            
            if (!customerCity) {
                showNotification('Preencha a cidade!', 'error');
                document.getElementById('customerCity').focus();
                return false;
            }
            
            if (!customerState) {
                showNotification('Selecione o estado!', 'error');
                document.getElementById('customerState').focus();
                return false;
            }
            
            return true;
        }
        
        function processOrder() {
            if (!validateOrderForm()) return;
            
            // Calcular total
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = subtotal > 50 ? 0 : 10;
            const total = subtotal + shipping;
            
            // Gerar número do pedido
            currentOrderNumber = generateOrderNumber();
            
            try {
                // Gerar código PIX
                const pixCodeValue = generatePixCode(total, currentOrderNumber);
                
                // Atualizar display
                pixAmount.textContent = `R$ ${total.toFixed(2)}`;
                pixCode.textContent = pixCodeValue;
                
                // Gerar QR Code
                generateQRCode(pixCodeValue);
                
                // Criar objeto do pedido
                const order = {
                    customer: {
                        name: document.getElementById('customerName').value.trim(),
                        phone: document.getElementById('customerPhone').value.trim(),
                        email: document.getElementById('customerEmail').value.trim(),
                        cep: document.getElementById('customerCEP').value.trim(),
                        address: document.getElementById('customerAddress').value.trim(),
                        number: document.getElementById('customerNumber').value.trim(),
                        complement: document.getElementById('customerComplement').value.trim(),
                        city: document.getElementById('customerCity').value.trim(),
                        state: document.getElementById('customerState').value
                    },
                    items: [...cart],
                    subtotal: subtotal,
                    shipping: shipping,
                    total: total,
                    orderNumber: currentOrderNumber,
                    date: new Date().toISOString(),
                    status: 'pending',
                    pixCode: pixCodeValue
                };
                
                // Salvar pedido
                saveOrder(order);
                
                // Fechar modal de checkout
                checkoutModal.style.display = 'none';
                
                // Mostrar modal PIX
                pixModal.style.display = 'flex';
                
                // Adicionar evento de cópia ao código PIX
                pixCode.onclick = function() {
                    navigator.clipboard.writeText(pixCodeValue).then(() => {
                        showNotification('Código PIX copiado para a área de transferência!');
                    }).catch(err => {
                        // Método alternativo para cópia
                        const textArea = document.createElement('textarea');
                        textArea.value = pixCodeValue;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showNotification('Código PIX copiado!');
                    });
                };
                
            } catch (error) {
                showNotification(`Erro: ${error.message}`, 'error');
                console.error('Erro ao processar pedido:', error);
            }
        }
        
        function saveOrder(order) {
            orders.unshift(order);
            localStorage.setItem('apostilas_premium_orders', JSON.stringify(orders));
            updateOrdersList();
            
            // Aqui você poderia enviar o pedido para um backend real
            console.log('Pedido salvo:', order);
            
            // Enviar e-mail de notificação (simulado)
            sendOrderNotification(order);
        }
        
        function sendOrderNotification(order) {
            // Esta função simula o envio de notificação por e-mail
            console.log(`Notificação enviada para ${order.customer.email}`);
            console.log(`Pedido #${order.orderNumber} - Total: R$ ${order.total.toFixed(2)}`);
        }
        
        function updateOrdersList() {
            ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p style="text-align: center; color: #666;">Nenhum pedido ainda</p>';
                return;
            }
            
            orders.slice(0, 10).forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.style.cssText = `
                    padding: 15px;
                    margin-bottom: 10px;
                    background-color: #f8f9fa;
                    border-radius: 5px;
                    border-left: 4px solid ${order.status === 'paid' ? '#2ecc71' : '#f39c12'};
                `;
                
                const itemsText = order.items.map(item => 
                    `${item.name} (${item.quantity}x)`
                ).join(', ');
                
                orderElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>#${order.orderNumber}</strong><br>
                            <small>${new Date(order.date).toLocaleDateString()}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>R$ ${order.total.toFixed(2)}</strong><br>
                            <small style="color: ${order.status === 'paid' ? '#2ecc71' : '#f39c12'}">
                                ${order.status === 'paid' ? 'Pago' : 'Pendente'}
                            </small>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <div><strong>Cliente:</strong> ${order.customer.name}</div>
                        <div><strong>Endereço:</strong> ${order.customer.address}, ${order.customer.number}${order.customer.complement ? ' - ' + order.customer.complement : ''}</div>
                        <div><strong>Itens:</strong> ${itemsText}</div>
                    </div>
                `;
                
                ordersList.appendChild(orderElement);
            });
        }

        // ================= ADMIN FUNCTIONS =================
        function loadPixConfig() {
            const savedConfig = localStorage.getItem('apostilas_premium_pix_config');
            if (savedConfig) {
                pixConfig = JSON.parse(savedConfig);
            } else {
                // Salvar configuração padrão
                localStorage.setItem('apostilas_premium_pix_config', JSON.stringify(pixConfig));
            }
            
            // Atualizar campos do formulário
            document.getElementById('pixKey').value = pixConfig.key || '';
            document.getElementById('pixName').value = pixConfig.name || '';
            document.getElementById('pixCity').value = pixConfig.city || '';
            
            const savedOrders = localStorage.getItem('apostilas_premium_orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
                updateOrdersList();
            }
        }
        
        function savePixConfig() {
            const key = document.getElementById('pixKey').value.trim();
            const name = document.getElementById('pixName').value.trim();
            const city = document.getElementById('pixCity').value.trim();
            
            if (!key || !name || !city) {
                showNotification('Preencha todos os campos obrigatórios!', 'error');
                return;
            }
            
            pixConfig = { key, name, city, type: "CPF" };
            localStorage.setItem('apostilas_premium_pix_config', JSON.stringify(pixConfig));
            
            const statusDiv = document.getElementById('pixConfigStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<i class="fas fa-check"></i> Configurações salvas com sucesso!';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
            
            showNotification('Configurações PIX salvas!');
        }

        // ================= EVENT LISTENERS =================
        cartIcon.addEventListener('click', () => {
            cartModal.style.display = 'flex';
        });
        
        closeModal.forEach(button => {
            button.addEventListener('click', () => {
                cartModal.style.display = 'none';
                checkoutModal.style.display = 'none';
                pixModal.style.display = 'none';
                loadingModal.style.display = 'none';
                successModal.style.display = 'none';
                adminModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === cartModal) cartModal.style.display = 'none';
            if (e.target === checkoutModal) checkoutModal.style.display = 'none';
            if (e.target === pixModal) pixModal.style.display = 'none';
            if (e.target === loadingModal) loadingModal.style.display = 'none';
            if (e.target === successModal) successModal.style.display = 'none';
            if (e.target === adminModal) adminModal.style.display = 'none';
        });
        
        addToCartButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                const name = e.target.getAttribute('data-name');
                const price = e.target.getAttribute('data-price');
                
                addToCart(id, name, price);
                
                e.target.textContent = 'Adicionado!';
                e.target.style.backgroundColor = '#2ecc71';
                
                setTimeout(() => {
                    e.target.textContent = 'Adicionar ao Carrinho';
                    e.target.style.backgroundColor = '';
                }, 1500);
            });
        });
        
        addCustomToCartButton.addEventListener('click', () => {
            const pageCount = document.getElementById('pageCount').value;
            const paperType = document.getElementById('paperType').value;
            const printingType = document.getElementById('printingType').value;
            const fileUpload = document.getElementById('fileUpload').files[0];
            const observations = document.getElementById('observations').value;
            
            let basePrice = 12.90;
            
            if (pageCount === '51-100') basePrice = 19.90;
            else if (pageCount === '101-150') basePrice = 24.90;
            else if (pageCount === '151-200') basePrice = 29.90;
            
            if (paperType === '90g') basePrice += 5;
            else if (paperType === 'reciclado') basePrice += 2;
            
            if (printingType === 'colorido') basePrice += 15;
            else if (printingType === 'misto') basePrice += 8;
            
            let description = `Personalizada: ${pageCount} páginas, ${getPaperTypeName(paperType)}, ${getPrintingTypeName(printingType)}`;
            if (observations) description += `, ${observations}`;
            if (fileUpload) description += `, Arquivo: ${fileUpload.name}`;
            
            addToCart('custom', 'Apostila Personalizada', basePrice.toFixed(2), description);
            
            addCustomToCartButton.textContent = 'Adicionado ao Carrinho!';
            addCustomToCartButton.style.backgroundColor = '#2ecc71';
            
            setTimeout(() => {
                addCustomToCartButton.textContent = 'Adicionar ao Carrinho';
                addCustomToCartButton.style.backgroundColor = '';
            }, 1500);
        });
        
        checkoutButton.addEventListener('click', () => {
            if (cart.length === 0) {
                showNotification('Seu carrinho está vazio!', 'error');
                return;
            }
            
            cartModal.style.display = 'none';
            checkoutModal.style.display = 'flex';
        });
        
        confirmPurchaseButton.addEventListener('click', () => {
            processOrder();
        });
        
        // Copiar código PIX ao clicar
        pixCode.addEventListener('click', () => {
            if (pixCode.textContent && !pixCode.textContent.includes('Clique em')) {
                navigator.clipboard.writeText(pixCode.textContent).then(() => {
                    showNotification('Código PIX copiado! Cole no seu app de banco.');
                }).catch(err => {
                    // Método alternativo para cópia
                    const textArea = document.createElement('textarea');
                    textArea.value = pixCode.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Código PIX copiado!');
                });
            }
        });
        
        // Simular pagamento PIX
        pixPaidBtn.addEventListener('click', () => {
            pixModal.style.display = 'none';
            loadingText.textContent = 'Confirmando pagamento...';
            loadingModal.style.display = 'flex';
            
            setTimeout(() => {
                loadingModal.style.display = 'none';
                
                // Atualizar status do pedido
                const orderIndex = orders.findIndex(o => o.orderNumber === currentOrderNumber);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = 'paid';
                    orders[orderIndex].paidDate = new Date().toISOString();
                    localStorage.setItem('apostilas_premium_orders', JSON.stringify(orders));
                    updateOrdersList();
                }
                
                orderNumber.textContent = currentOrderNumber;
                successModal.style.display = 'flex';
                
                // Limpar carrinho
                cart = [];
                updateCart();
                
                // Limpar formulário
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerCEP').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('customerNumber').value = '';
                document.getElementById('customerComplement').value = '';
                document.getElementById('customerCity').value = '';
                document.getElementById('customerState').value = '';
                
            }, 2000);
        });
        
        successButton.addEventListener('click', () => {
            successModal.style.display = 'none';
        });
        
        // Admin
        adminBtn.addEventListener('click', () => {
            adminModal.style.display = 'flex';
        });
        
        adminTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                adminTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
            });
        });
        
        savePixConfigBtn.addEventListener('click', savePixConfig);
        
        clearOrdersBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja limpar todos os pedidos?')) {
                orders = [];
                localStorage.removeItem('apostilas_premium_orders');
                updateOrdersList();
                showNotification('Pedidos limpos!');
            }
        });

        // ================= FORMULÁRIO - EVENTOS =================
        // Formatar CEP enquanto digita
        customerCEP.addEventListener('input', function(e) {
            this.value = formatCEP(this.value);
            
            // Buscar CEP quando tiver 9 caracteres (xxxxx-xxx)
            if (this.value.length === 9) {
                buscarCEP(this.value);
            }
        });
        
        // Formatar telefone enquanto digita
        document.getElementById('customerPhone').addEventListener('input', function(e) {
            this.value = formatPhone(this.value);
        });
        
        // Limpar formulário quando abrir o checkout
        checkoutButton.addEventListener('click', () => {
            // Não limpar os campos, apenas garantir que o formulário está visível
            // O usuário pode querer editar informações já preenchidas
            setTimeout(() => {
                document.getElementById('customerName').focus();
            }, 300);
        });

        // ================= FUNÇÕES AUXILIARES =================
        function getPaperTypeName(value) {
            switch(value) {
                case '75g': return 'Papel Offset 75g/m²';
                case '90g': return 'Papel Premium 90g/m²';
                case 'reciclado': return 'Papel Reciclado 80g/m²';
                default: return '';
            }
        }
        
        function getPrintingTypeName(value) {
            switch(value) {
                case 'preto-branco': return 'Impressão P&B';
                case 'colorido': return 'Impressão Colorida';
                case 'misto': return 'Impressão Mista';
                default: return '';
            }
        }

        // ================= INICIALIZAÇÃO =================
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        updateCart();
        loadPixConfig();
        
        // Mostrar mensagem inicial sobre o PIX
        console.log('PIX configurado com CPF:', pixConfig.key);
        console.log('Nome:', pixConfig.name);
        console.log('Cidade:', pixConfig.city);
        
        // Adicionar máscara de CEP usando jQuery (para compatibilidade)
        if (typeof $ !== 'undefined') {
            $(document).ready(function() {
                $('#customerCEP').mask('00000-000');
                $('#customerPhone').mask('(00) 00000-0000');
            });
        }
    </script>
</body>
</html>
